<html lang="id" class="scroll-smooth">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Aplikasi Tabungan - Dengan Tab Responsif & Interaktif</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Scrollbar for horizontal tab on mobile */
        nav ul {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #3b82f6 #e5e7eb;
        }

        nav ul::-webkit-scrollbar {
            height: 6px;
        }

        nav ul::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 3px;
        }

        nav ul::-webkit-scrollbar-thumb {
            background-color: #3b82f6;
            border-radius: 3px;
        }

        /* Focus visible for accessibility */
        [role="tab"]:focus-visible {
            outline: 3px solid #2563eb;
            outline-offset: 2px;
        }

        /* Alert container */
        #alertContainer {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 60;
            max-width: 320px;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* Animation */
        @keyframes slideInRight {
            0% {
                transform: translateX(100%);
                opacity: 0;
            }

            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            0% {
                transform: translateX(0);
                opacity: 1;
            }

            100% {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">
    <header class="bg-blue-600 text-white shadow-md sticky top-0 z-30">
        <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
            <h1 class="text-2xl font-semibold flex items-center gap-2 select-none">
                <i class="fas fa-piggy-bank"></i> Aplikasi Tabungan
            </h1>
            <button id="btnOpenTabs" aria-label="Buka menu tab"
                class="sm:hidden p-2 rounded-md hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-white">
                <i class="fas fa-bars text-xl"></i>
            </button>
        </div>
    </header>

    <main class="flex-grow max-w-5xl mx-auto px-4 py-6 w-full flex flex-col">
        <!-- Tab Menus -->

        <section id="panel-member" role="tabpanel" aria-labelledby="tab-member" tabindex="0"
            class="tab-panel focus:outline-none">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold mb-4 text-blue-700">Daftar Member</h2>
                <button id="btnAddMember"
                    class="bg-blue-600 hover:bg-blue-700 text-white text-base font-semibold py-2 px-4 rounded-md transition flex items-center space-x-2">
                    <i class="fas fa-plus"></i>
                    <span class="hidden sm:inline">
                        Tambah Data Member
                    </span>
                </button>
            </div>

            <!-- Member search and filter controls -->
            <div class="mb-4">
                <div class="mx-auto flex flex-col sm:flex-row gap-3 justify-between items-start">
                    <div class="w-full sm:w-auto">
                        <div class="relative">
                            <input id="memberSearch" type="text" placeholder="Cari nama member..."
                                class="w-full bg-white pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <div class="absolute left-3 top-2.5 text-gray-400">
                                <i class="fas fa-search"></i>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between gap-2 w-full sm:w-auto">
                        <select id="sortMembers"
                            class="bg-white border border-gray-300 text-gray-700 py-2 px-4 pr-8 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="name-asc">Nama (A-Z)</option>
                            <option value="name-desc">Nama (Z-A)</option>
                        </select>
                        <button id="btnFilterMembers"
                            class="bg-blue-100 hover:bg-blue-200 text-blue-800 font-medium py-2 px-4 rounded-lg transition flex items-center space-x-1">
                            <i class="fas fa-filter"></i>
                            <span class="hidden sm:inline">Filter</span>
                        </button>
                    </div>
                </div>

                <!-- Member filter panel -->
                <div id="memberFilterPanel" class="mt-4 p-4 bg-blue-50 rounded-lg hidden">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="w-full">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Catatan Berisi</label>
                            <input type="text" id="filterNotes" placeholder="Kata kunci dalam catatan"
                                class="w-full bg-white border border-gray-300 rounded-md py-2 px-3">
                        </div>
                    </div>
                    <div class="flex justify-end mt-4 gap-2">
                        <button id="btnResetMemberFilters"
                            class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-1.5 px-4 rounded transition">
                            Reset
                        </button>
                        <button id="btnApplyMemberFilters"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-1.5 px-4 rounded transition">
                            Terapkan
                        </button>
                    </div>
                </div>
            </div>

            <div id="membersList" class="space-y-4 mx-auto">
                <p class="text-center text-gray-500">Belum ada member terdaftar.</p>
            </div>

            <!-- Pagination controls -->
            <div id="paginationControls" class="flex justify-center items-center mt-4 space-x-2 hidden"></div>
            <div id="memberCounter" class="text-center text-gray-500 mt-2"></div>

            <!-- Modal for adding new members -->
            <div id="memberModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-blue-700">Daftar Member Baru</h3>
                        <button id="closeModal" class="text-gray-500 hover:text-gray-700 focus:outline-none">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <form id="memberForm" class="space-y-4">
                        <div>
                            <label for="memberName" class="block text-gray-700 font-medium mb-1">Nama Member</label>
                            <input type="text" id="memberName" name="memberName" required
                                placeholder="Masukkan nama lengkap"
                                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                autocomplete="off" />
                        </div>
                        <div>
                            <label for="targetTabungan" class="block text-gray-700 font-medium mb-1">Target Jumlah
                                Tabungan (Rp)</label>
                            <input type="number" id="targetTabungan" name="targetTabungan" min="0" required
                                placeholder="Masukkan target tabungan"
                                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                autocomplete="off" />
                        </div>
                        <div>
                            <label for="memberNote" class="block text-gray-700 font-medium mb-1">Catatan
                                (opsional)</label>
                            <textarea id="memberNote" name="memberNote" rows="3"
                                placeholder="Tambahkan catatan untuk member ini"
                                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                autocomplete="off"></textarea>
                        </div>
                        <button type="submit"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-md transition">
                            Daftarkan Member
                        </button>
                    </form>
                </div>
            </div>

            <!-- Modal for editing members -->
            <div id="editMemberModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-blue-700">Edit Member</h3>
                        <button id="closeEditModal" class="text-gray-500 hover:text-gray-700 focus:outline-none">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <form id="editMemberForm" class="space-y-4">
                        <input type="hidden" id="editMemberIndex">
                        <div>
                            <label for="editMemberName" class="block text-gray-700 font-medium mb-1">Nama Member</label>
                            <input type="text" id="editMemberName" name="editMemberName" required
                                placeholder="Masukkan nama lengkap"
                                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                autocomplete="off" />
                        </div>
                        <div>
                            <label for="editTargetTabungan" class="block text-gray-700 font-medium mb-1">Target Jumlah
                                Tabungan (Rp)</label>
                            <input type="number" id="editTargetTabungan" name="editTargetTabungan" min="0" required
                                placeholder="Masukkan target tabungan"
                                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                autocomplete="off" />
                        </div>
                        <div>
                            <label for="editMemberNote" class="block text-gray-700 font-medium mb-1">Catatan
                                (opsional)</label>
                            <textarea id="editMemberNote" name="editMemberNote" rows="3"
                                placeholder="Tambahkan catatan untuk member ini"
                                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                autocomplete="off"></textarea>
                        </div>
                        <button type="submit"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-md transition">
                            Simpan Perubahan
                        </button>
                    </form>
                </div>
            </div>

            <!-- Confirmation Modal for Delete Member -->
            <div id="deleteMemberModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full">
                    <div class="mb-4">
                        <h3 class="text-xl font-semibold text-red-700">Konfirmasi Hapus Member</h3>
                    </div>
                    <p class="text-gray-700 mb-6">Anda yakin ingin menghapus member <span id="deleteMemberName"
                            class="font-semibold"></span>? Semua data tabungan terkait juga akan dihapus.</p>
                    <div class="flex gap-3 justify-end">
                        <button id="cancelDelete"
                            class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md transition">
                            Batal
                        </button>
                        <button id="confirmDelete"
                            class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md transition">
                            Hapus
                        </button>
                    </div>
                    <input type="hidden" id="deleteMemberIndex">
                </div>
            </div>

            <!-- Modal for Detail Savings -->
            <div id="detailSavingsModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-blue-700">Detail Tabungan <span id="savingsMemberName"></span></h3>
                        <button id="closeDetailSavingsModal" class="text-gray-500 hover:text-gray-700 focus:outline-none">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div id="savingsDetailContent" class="space-y-4">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-700">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                    <tr>
                                        <th scope="col" class="px-4 py-3">Tanggal</th>
                                        <th scope="col" class="px-4 py-3">Jenis</th>
                                        <th scope="col" class="px-4 py-3 text-right">Jumlah</th>
                                    </tr>
                                </thead>
                                <tbody id="savingsDetailTable">
                                    <!-- Savings details will be inserted here dynamically -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <p class="text-right font-medium">Total: <span id="totalSavingsAmount" class="text-blue-700 font-semibold"></span></p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-blue-600 text-white py-4 mt-auto">
        <div class="max-w-5xl mx-auto px-4 text-center text-sm select-none">
            &copy; 2024 Aplikasi Tabungan. All rights reserved.
        </div>
    </footer>

    <div id="alertContainer" aria-live="assertive" aria-atomic="true"></div>

    <script>
        $(document).ready(function () {
            // Data structure to hold members and their savings
            let members = [];

            // Fetch data from JSON file
            $.getJSON('data.json', function (data) {
                members = data;
                renderMembers(); // Render members after fetching data
            }).fail(function () {
                showAlert('Gagal memuat data dari file JSON.', 'error');
            });

            // Pagination configuration
            const paginationConfig = {
                membersPerPage: 5,
                currentPage: 1,
                totalPages: Math.ceil(members.length / 5)
            };

            // Format number to Indonesian Rupiah currency format
            function formatRupiah(number) {
                return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(number);
            }

            // Format date to dd-mm-yyyy
            function formatDate(date) {
                const d = new Date(date);
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear();
                return `${day}-${month}-${year}`;
            }

            // Show alert function
            function showAlert(message, type = 'info', duration = 4000) {
                const id = `alert-${Date.now()}`;
                const colors = {
                    info: 'bg-blue-100 text-blue-800',
                    success: 'bg-green-100 text-green-800',
                    error: 'bg-red-100 text-red-800',
                    warning: 'bg-yellow-100 text-yellow-800',
                };
                const icons = {
                    info: '<i class="fas fa-info-circle mr-2"></i>',
                    success: '<i class="fas fa-check-circle mr-2"></i>',
                    error: '<i class="fas fa-exclamation-circle mr-2"></i>',
                    warning: '<i class="fas fa-exclamation-triangle mr-2"></i>',
                };

                const alert = $(`
                    <div id="${id}" role="alert" class="flex items-center ${colors[type] || colors.info} rounded-md shadow-md p-3 animate-[slideInRight_0.3s_ease_forwards]">
                        <span class="flex-shrink-0 text-lg">${icons[type] || icons.info}</span>
                        <p class="flex-grow text-sm font-medium">${message}</p>
                        <button aria-label="Tutup notifikasi" class="ml-3 text-lg font-bold focus:outline-none hover:text-opacity-70 transition" type="button">&times;</button>
                    </div>
                `);

                $('#alertContainer').append(alert);

                // Close button event
                alert.find('button').on('click', function () {
                    closeAlert(alert);
                });

                // Auto close after duration
                setTimeout(function () {
                    closeAlert(alert);
                }, duration);
            }

            // Close alert with animation
            function closeAlert(alert) {
                alert.css('animation', 'slideOutRight 0.3s ease forwards');
                alert.on('animationend', function () {
                    $(this).remove();
                });
            }

            // Get paginated members
            function getPaginatedMembers() {
                const startIndex = (paginationConfig.currentPage - 1) * paginationConfig.membersPerPage;
                const endIndex = startIndex + paginationConfig.membersPerPage;
                return members.slice(startIndex, endIndex);
            }

            // Render pagination controls
            function renderPagination() {
                const totalPages = Math.ceil(members.length / paginationConfig.membersPerPage);
                paginationConfig.totalPages = totalPages;

                if (totalPages <= 1) {
                    $('#paginationControls').addClass('hidden');
                    return;
                }

                $('#paginationControls').removeClass('hidden');

                let paginationHTML = '';

                // Previous button
                paginationHTML += `
                    <button id="prevPage" class="px-3 py-1 rounded-md flex items-center ${paginationConfig.currentPage === 1 ? 'text-gray-400 cursor-not-allowed' : 'text-blue-600 hover:bg-blue-100'}"
                    ${paginationConfig.currentPage === 1 ? 'disabled' : ''}>
                        <i class="fas fa-chevron-left mr-1"></i> Prev
                    </button>
                `;

                let pages = [];
                const currentPage = paginationConfig.currentPage;

                // Always show first page
                pages.push(1);

                // Show ellipsis after first page if needed
                if (currentPage > 3) {
                    pages.push('...');
                }

                // Show pages around current page
                for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) {
                    pages.push(i);
                }

                // Show ellipsis before last page if needed
                if (currentPage < totalPages - 2) {
                    pages.push('...');
                }

                // Always show last page if there is more than one page
                if (totalPages > 1) {
                    pages.push(totalPages);
                }

                // Render page numbers
                pages.forEach(page => {
                    if (page === '...') {
                        paginationHTML += `
                            <span class="px-3 py-1 text-gray-500">...</span>
                        `;
                    } else {
                        paginationHTML += `
                            <button class="page-number px-3 py-1 rounded-md ${page === currentPage ?
                                'bg-blue-600 text-white' :
                                'text-gray-700 hover:bg-blue-100'}" 
                                data-page="${page}">
                                ${page}
                            </button>
                        `;
                    }
                });

                // Next button
                paginationHTML += `
                    <button id="nextPage" class="px-3 py-1 rounded-md flex items-center ${paginationConfig.currentPage === totalPages ? 'text-gray-400 cursor-not-allowed' : 'text-blue-600 hover:bg-blue-100'}"
                    ${paginationConfig.currentPage === totalPages ? 'disabled' : ''}>
                        Next <i class="fas fa-chevron-right ml-1"></i>
                    </button>
                `;

                $('#paginationControls').html(paginationHTML);

                // Add event listeners for pagination
                $('.page-number').on('click', function () {
                    paginationConfig.currentPage = parseInt($(this).data('page'));
                    renderMembers();
                });

                $('#prevPage').on('click', function () {
                    if (paginationConfig.currentPage > 1) {
                        paginationConfig.currentPage--;
                        renderMembers();
                    }
                });

                $('#nextPage').on('click', function () {
                    if (paginationConfig.currentPage < totalPages) {
                        paginationConfig.currentPage++;
                        renderMembers();
                    }
                });
            }

            // Render members list with total tabungan and total jimpitan
            function renderMembers() {
                $('#membersList').empty();

                // Get paginated members
                const paginatedMembers = getPaginatedMembers();

                if (members.length === 0) {
                    $('#membersList').html(`
                        <div class="text-center py-8">
                            <div class="flex justify-center mb-4">
                                <i class="fas fa-users text-gray-300 text-5xl"></i>
                            </div>
                            <p class="text-center text-gray-500">Belum ada member terdaftar.</p>
                            <p class="text-sm text-gray-400 mt-2">Tambahkan member baru dengan mengklik tombol "Tambah Data Member"</p>
                        </div>
                    `);
                    $('#paginationControls').addClass('hidden');
                    return;
                }

                // Show member counter
                const startIndex = (paginationConfig.currentPage - 1) * paginationConfig.membersPerPage;
                const endIndex = Math.min(startIndex + paginationConfig.membersPerPage, members.length);
                $('#memberCounter').html(`Menampilkan ${startIndex + 1}-${endIndex} dari ${members.length} member`);

                $.each(paginatedMembers, function (index, member) {
                    const totalTabungan = member.savings
                        .filter(saving => saving.type === 'tabungan')
                        .reduce((acc, cur) => acc + cur.amount, 0);

                    const totalJimpitan = member.savings
                        .filter(saving => saving.type === 'jimpitan')
                        .reduce((acc, cur) => acc + cur.amount, 0);

                    const totalSaved = totalTabungan + totalJimpitan;

                    const memberCard = $(`
                        <div class="bg-white p-4 rounded-lg shadow flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 relative">
                            <div class="absolute top-2 right-2 flex gap-2">
                                <button class="btn-menu-member text-gray-600 hover:text-blue-800 text-sm flex items-center gap-1 p-1" data-index="${startIndex + index}" aria-haspopup="true" aria-expanded="false">
                                    <i class="fa-solid fa-ellipsis-vertical"></i>
                                </button>
                                <div class="member-dropdown-menu absolute right-0 top-full mt-1 bg-white shadow-lg rounded-md py-1 z-10 hidden min-w-[200px]">
                                    <button class="btn-detail-savings w-full text-left px-4 py-2 text-gray-600 hover:bg-blue-50 flex items-center gap-2" data-index="${startIndex + index}">
                                        <i class="fas fa-list"></i> Detail Tabungan
                                    </button>
                                    <button class="btn-edit-member w-full text-left px-4 py-2 text-blue-600 hover:bg-blue-50 flex items-center gap-2" data-index="${startIndex + index}">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn-delete-member w-full text-left px-4 py-2 text-red-600 hover:bg-red-50 flex items-center gap-2" data-index="${startIndex + index}">
                                        <i class="fas fa-trash-alt"></i> Hapus
                                    </button>
                                </div>
                            </div>
                            <div class="flex-grow">
                                <h3 class="text-lg font-semibold text-blue-800">${member.name}</h3>
                                <p class="text-gray-600">Total Tabungan: <span class="font-semibold">${formatRupiah(totalTabungan)}</span></p>
                                <p class="text-gray-600">Total Jimpitan: <span class="font-semibold">${formatRupiah(totalJimpitan)}</span></p>
                                ${member.note ? `<div class="mt-2 bg-yellow-50 p-2 rounded-md">
                                    <p class="text-gray-700 text-sm"><i class="fas fa-sticky-note text-yellow-500 mr-1"></i> <span class="italic">${member.note}</span></p>
                                </div>` : ''}
                            </div>
                            <div class="w-full sm:w-48 flex flex-col gap-1">
                                <p class="text-sm font-medium text-gray-700 text-right">Total: ${formatRupiah(totalSaved)}</p>
                            </div>
                        </div>
                    `);

                    $('#membersList').append(memberCard);
                });

                // Render pagination controls
                renderPagination();

                // Update select options
                $('#selectMember').html('<option value="" disabled selected>Pilih member</option>');

                $.each(members, function (index, member) {
                    $('#selectMember').append(`<option value="${index}">${member.name}</option>`);
                });
            }

            // Handle member registration
            $('#memberForm').on('submit', function (e) {
                e.preventDefault();
                const name = $('#memberName').val().trim();
                const target = parseInt($('#targetTabungan').val());

                if (!name || target < 0) {
                    showAlert('Mohon isi data dengan benar.', 'error');
                    return;
                }

                // Check if member name already exists (case insensitive)
                const exists = members.some(m => m.name.toLowerCase() === name.toLowerCase());
                if (exists) {
                    showAlert('Member dengan nama tersebut sudah terdaftar.', 'warning');
                    return;
                }

                members.push({
                    name,
                    target,
                    note: $('#memberNote').val().trim(),
                    savings: [],
                });

                $(this)[0].reset();
                $('#memberModal').addClass('hidden');
                $('body').css('overflow', '');
                // After adding a new member, go to the last page to show the new member
                paginationConfig.currentPage = Math.ceil(members.length / paginationConfig.membersPerPage);
                renderMembers();
                showAlert(`Member "${name}" berhasil didaftarkan.`, 'success');
            });

            // Handle adding savings
            $('#savingsForm').on('submit', function (e) {
                e.preventDefault();
                const memberIndex = parseInt($('#selectMember').val());
                const amount = parseInt($('#amount').val());

                if (isNaN(memberIndex) || memberIndex < 0 || memberIndex >= members.length) {
                    showAlert('Pilih member yang valid.', 'error');
                    return;
                }
                if (isNaN(amount) || amount <= 0) {
                    showAlert('Masukkan jumlah tabungan yang valid.', 'error');
                    return;
                }

                const today = new Date().toISOString();

                members[memberIndex].savings.push({
                    date: today,
                    amount,
                });

                $(this)[0].reset();
                renderMembers();
                showAlert(`Tabungan sebesar ${formatRupiah(amount)} berhasil ditambahkan untuk member "${members[memberIndex].name}".`, 'success');
            });


            // Close mobile menu on Escape key globally
            $(document).on('keydown', function (e) {
                if (e.key === 'Escape' && !$('#mobileTabsMenu').hasClass('hidden')) {
                    closeMobileTabsMenu();
                }
            });

            // Initialize first tab as selected desktop and mobile
            $('#tabsList [role="tab"]').eq(0)
                .attr('aria-selected', 'true')
                .addClass('border-blue-600 text-blue-600')
                .removeClass('border-transparent text-gray-500');

            $('#mobileTabsMenu [role="tab"]').eq(0)
                .attr('aria-selected', 'true')
                .addClass('bg-blue-100 font-semibold')
                .removeClass('text-gray-700');

            // Initial render
            renderMembers();

            // ===== Edit Member Functionality =====

            // Toggle dropdown menu for members
            $(document).on('click', '.btn-menu-member', function (e) {
                e.stopPropagation(); // Prevent event bubbling
                const dropdown = $(this).siblings('.member-dropdown-menu');

                // Close all other dropdowns first
                $('.member-dropdown-menu').not(dropdown).addClass('hidden');

                // Toggle current dropdown
                dropdown.toggleClass('hidden');

                // Update aria-expanded state
                $(this).attr('aria-expanded', !dropdown.hasClass('hidden'));
            });

            // Close all dropdowns when clicking outside
            $(document).on('click', function () {
                $('.member-dropdown-menu').addClass('hidden');
                $('.btn-menu-member').attr('aria-expanded', 'false');
            });

            // Open edit member modal
            $(document).on('click', '.btn-edit-member', function () {
                const index = $(this).data('index');
                const member = members[index];

                $('#editMemberIndex').val(index);
                $('#editMemberName').val(member.name);
                $('#editTargetTabungan').val(member.target);
                $('#editMemberNote').val(member.note || '');

                $('#editMemberModal').removeClass('hidden');
                $('#editMemberName').focus();
                $('body').css('overflow', 'hidden');
            });

            // Close edit member modal
            $('#closeEditModal').on('click', function () {
                $('#editMemberModal').addClass('hidden');
                $('body').css('overflow', '');
            });

            // Close edit modal when clicking outside
            $('#editMemberModal').on('click', function (e) {
                if (e.target === this) {
                    $('#editMemberModal').addClass('hidden');
                    $('body').css('overflow', '');
                }
            });

            // Close edit modal on Escape key
            $(document).on('keydown', function (e) {
                if (e.key === 'Escape' && !$('#editMemberModal').hasClass('hidden')) {
                    $('#editMemberModal').addClass('hidden');
                    $('body').css('overflow', '');
                }
            });

            // Save edit member form
            $('#editMemberForm').on('submit', function (e) {
                e.preventDefault();
                const index = parseInt($('#editMemberIndex').val());
                const name = $('#editMemberName').val().trim();
                const target = parseInt($('#editTargetTabungan').val());

                if (!name || target < 0) {
                    showAlert('Mohon isi data dengan benar.', 'error');
                    return;
                }

                // Check if new name already exists (excluding the current member)
                const nameExists = members.some((m, i) => i !== index && m.name.toLowerCase() === name.toLowerCase());
                if (nameExists) {
                    showAlert('Member dengan nama tersebut sudah terdaftar.', 'warning');
                    return;
                }

                // Update the member data
                members[index].name = name;
                members[index].target = target;
                members[index].note = $('#editMemberNote').val().trim();

                $('#editMemberModal').addClass('hidden');
                $('body').css('overflow', '');
                renderMembers();
                showAlert(`Data member "${name}" berhasil diperbarui.`, 'success');
            });

            // ===== Delete Member Functionality =====

            // Open delete confirmation modal
            $(document).on('click', '.btn-delete-member', function () {
                const index = $(this).data('index');
                const member = members[index];

                $('#deleteMemberIndex').val(index);
                $('#deleteMemberName').text(member.name);

                $('#deleteMemberModal').removeClass('hidden');
                $('body').css('overflow', 'hidden');
            });

            // Cancel delete
            $('#cancelDelete').on('click', function () {
                $('#deleteMemberModal').addClass('hidden');
                $('body').css('overflow', '');
            });

            // Confirm delete
            $('#confirmDelete').on('click', function () {
                const index = parseInt($('#deleteMemberIndex').val());
                const memberName = members[index].name;

                members.splice(index, 1);

                $('#deleteMemberModal').addClass('hidden');
                $('body').css('overflow', '');
                renderMembers();
                showAlert(`Member "${memberName}" berhasil dihapus.`, 'success');
            });

            // Close delete modal when clicking outside
            $('#deleteMemberModal').on('click', function (e) {
                if (e.target === this) {
                    $('#deleteMemberModal').addClass('hidden');
                    $('body').css('overflow', '');
                }
            });

            // Close delete modal on Escape key
            $(document).on('keydown', function (e) {
                if (e.key === 'Escape' && !$('#deleteMemberModal').hasClass('hidden')) {
                    $('#deleteMemberModal').addClass('hidden');
                    $('body').css('overflow', '');
                }
            });

            // ===== Detail Savings Functionality =====
            
            // Open detail savings modal
            $(document).on('click', '.btn-detail-savings', function () {
                const index = $(this).data('index');
                const member = members[index];
                
                // Set member name in modal title
                $('#savingsMemberName').text(member.name);
                
                // Clear previous content
                $('#savingsDetailTable').empty();
                
                // Sort savings by date (newest first)
                const sortedSavings = [...member.savings].sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                );
                
                // Calculate total savings
                const totalSavings = member.savings.reduce((acc, cur) => acc + cur.amount, 0);
                
                // Display each saving entry
                $.each(sortedSavings, function(i, saving) {
                    const formattedDate = formatDate(saving.date);
                    const formattedAmount = formatRupiah(saving.amount);
                    const savingType = saving.type.charAt(0).toUpperCase() + saving.type.slice(1); // Capitalize first letter
                    
                    const row = $(`
                        <tr class="${i % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                            <td class="px-4 py-2 whitespace-nowrap">${formattedDate}</td>
                            <td class="px-4 py-2">${savingType}</td>
                            <td class="px-4 py-2 text-right font-medium">${formattedAmount}</td>
                        </tr>
                    `);
                    
                    $('#savingsDetailTable').append(row);
                });
                
                // Show total amount
                $('#totalSavingsAmount').text(formatRupiah(totalSavings));
                
                // Show modal
                $('#detailSavingsModal').removeClass('hidden');
                $('body').css('overflow', 'hidden');
            });
            
            // Close detail savings modal
            $('#closeDetailSavingsModal').on('click', function() {
                $('#detailSavingsModal').addClass('hidden');
                $('body').css('overflow', '');
            });
            
            // Close detail savings modal when clicking outside
            $('#detailSavingsModal').on('click', function(e) {
                if (e.target === this) {
                    $(this).addClass('hidden');
                    $('body').css('overflow', '');
                }
            });
            
            // Close detail savings modal on Escape key
            $(document).on('keydown', function(e) {
                if (e.key === 'Escape' && !$('#detailSavingsModal').hasClass('hidden')) {
                    $('#detailSavingsModal').addClass('hidden');
                    $('body').css('overflow', '');
                }
            });

            // Modal functionality
            $('#btnAddMember').on('click', function () {
                $('#memberModal').removeClass('hidden');
                $('#memberName').focus();
                $('body').css('overflow', 'hidden');
            });

            $('#closeModal').on('click', function () {
                $('#memberModal').addClass('hidden');
                $('body').css('overflow', '');
            });

            // Modal for adding savings functionality
            $('#btnAddSavings').on('click', function () {
                $('#savingsModal').removeClass('hidden');
                $('#selectMember').focus();
                $('body').css('overflow', 'hidden');
            });

            $('#closeSavingsModal').on('click', function () {
                $('#savingsModal').addClass('hidden');
                $('body').css('overflow', '');
            });

            // Close modal when clicking outside of it
            $('#savingsModal').on('click', function (e) {
                if (e.target === this) {
                    $('#savingsModal').addClass('hidden');
                    $('body').css('overflow', '');
                }
            });

            // Close modal on Escape key for savings modal
            $(document).on('keydown', function (e) {
                if (e.key === 'Escape' && !$('#savingsModal').hasClass('hidden')) {
                    $('#savingsModal').addClass('hidden');
                    $('body').css('overflow', '');
                }
            });

            // Close modal when clicking outside of it
            $('#memberModal').on('click', function (e) {
                if (e.target === this) {
                    $('#memberModal').addClass('hidden');
                    $('body').css('overflow', '');
                }
            });

            // Close modal on Escape key
            $(document).on('keydown', function (e) {
                if (e.key === 'Escape' && !$('#memberModal').hasClass('hidden')) {
                    $('#memberModal').addClass('hidden');
                    $('body').css('overflow', '');
                }
            });

            // After form submission, close the modal
            $('#memberForm').on('submit', function (e) {
                e.preventDefault();
                const name = $('#memberName').val().trim();
                const target = parseInt($('#targetTabungan').val());

                if (!name || target < 0) {
                    showAlert('Mohon isi data dengan benar.', 'error');
                    return;
                }

                // Check if member name already exists (case insensitive)
                const exists = members.some(m => m.name.toLowerCase() === name.toLowerCase());
                if (exists) {
                    showAlert('Member dengan nama tersebut sudah terdaftar.', 'warning');
                    return;
                }

                members.push({
                    name,
                    target,
                    note: $('#memberNote').val().trim(),
                    savings: [],
                });

                $(this)[0].reset();
                $('#memberModal').addClass('hidden');
                $('body').css('overflow', '');
                renderMembers();
                showAlert(`Member "${name}" berhasil didaftarkan.`, 'success');
            });

            // Set up member filter functionality
            function setupMemberFilters() {
                // Toggle filter panel
                $('#btnFilterMembers').on('click', function () {
                    $('#memberFilterPanel').slideToggle(200);
                });

                // Reset filters
                $('#btnResetMemberFilters').on('click', function () {
                    $('#filterTargetMin').val('');
                    $('#filterTargetMax').val('');
                    $('#filterProgress').val('');
                    $('#filterNotes').val('');
                    $('#memberSearch').val('');
                    $('#sortMembers').val('name-asc');
                    applyMemberFilters();
                });

                // Apply filters
                $('#btnApplyMemberFilters').on('click', function () {
                    applyMemberFilters();
                });

                // Search as you type
                $('#memberSearch').on('input', function () {
                    applyMemberFilters();
                });

                // Sort change
                $('#sortMembers').on('change', function () {
                    applyMemberFilters();
                });
            }

            // Apply member filters
            function applyMemberFilters() {
                const searchText = $('#memberSearch').val().toLowerCase();
                const notesKeyword = $('#filterNotes').val().toLowerCase();
                const sortOption = $('#sortMembers').val();

                // Create a copy of the members array for filtering and sorting
                let filteredMembers = [...members];

                // Filter by search text (member name)
                if (searchText) {
                    filteredMembers = filteredMembers.filter(member =>
                        member.name.toLowerCase().includes(searchText)
                    );
                }

                // Filter by notes content
                if (notesKeyword) {
                    filteredMembers = filteredMembers.filter(member =>
                        member.note && member.note.toLowerCase().includes(notesKeyword)
                    );
                }

                // Sort the filtered results
                switch (sortOption) {
                    case 'name-asc':
                        filteredMembers.sort((a, b) => a.name.localeCompare(b.name));
                        break;
                    case 'name-desc':
                        filteredMembers.sort((a, b) => b.name.localeCompare(a.name));
                        break;
                }

                // Update members data and render with pagination
                renderFilteredMembers(filteredMembers);
            }

            // Render filtered members with pagination
            function renderFilteredMembers(filteredMembers) {
                // Update pagination configuration for filtered results
                paginationConfig.totalPages = Math.ceil(filteredMembers.length / paginationConfig.membersPerPage);

                // Reset to first page when filters change
                if (paginationConfig.currentPage > paginationConfig.totalPages && paginationConfig.totalPages > 0) {
                    paginationConfig.currentPage = 1;
                }

                $('#membersList').empty();

                // Check if we have results
                if (filteredMembers.length === 0) {
                    $('#membersList').html(`
                        <div class="text-center py-8">
                            <div class="flex justify-center mb-4">
                                <i class="fas fa-search text-gray-400 text-5xl"></i>
                            </div>
                            <p class="text-center text-gray-500">Tidak ada member yang sesuai dengan kriteria filter.</p>
                            <p class="text-sm text-gray-400 mt-2">Coba ubah filter atau kriteria pencarian.</p>
                        </div>
                    `);
                    $('#paginationControls').addClass('hidden');
                    $('#memberCounter').text('');
                    return;
                }

                // Get current page of filtered members
                const startIndex = (paginationConfig.currentPage - 1) * paginationConfig.membersPerPage;
                const paginatedMembers = filteredMembers.slice(
                    startIndex,
                    startIndex + paginationConfig.membersPerPage
                );

                // Render each member card
                $.each(paginatedMembers, function (index, member) {
                    const memberIndex = members.findIndex(m => m.name === member.name); // Find original index

                    const totalTabungan = member.savings
                        .filter(saving => saving.type === 'tabungan')
                        .reduce((acc, cur) => acc + cur.amount, 0);

                    const totalJimpitan = member.savings
                        .filter(saving => saving.type === 'jimpitan')
                        .reduce((acc, cur) => acc + cur.amount, 0);

                    const totalSaved = totalTabungan + totalJimpitan;

                    const memberCard = $(`
                        <div class="bg-white p-4 rounded-lg shadow flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 relative">
                            <div class="absolute top-2 right-2 flex gap-2">
                                <button class="btn-menu-member text-gray-600 hover:text-blue-800 text-sm flex items-center gap-1 p-1" data-index="${memberIndex}" aria-haspopup="true" aria-expanded="false">
                                    <i class="fa-solid fa-ellipsis-vertical"></i>
                                </button>
                                <div class="member-dropdown-menu absolute right-0 top-full mt-1 bg-white shadow-lg rounded-md py-1 z-10 hidden min-w-[200px]">
                                    <button class="btn-detail-savings w-full text-left px-4 py-2 text-gray-600 hover:bg-blue-50 flex items-center gap-2" data-index="${memberIndex}">
                                        <i class="fas fa-list"></i> Detail Tabungan
                                    </button>
                                    <button class="btn-edit-member w-full text-left px-4 py-2 text-blue-600 hover:bg-blue-50 flex items-center gap-2" data-index="${memberIndex}">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn-delete-member w-full text-left px-4 py-2 text-red-600 hover:bg-red-50 flex items-center gap-2" data-index="${memberIndex}">
                                        <i class="fas fa-trash-alt"></i> Hapus
                                    </button>
                                </div>
                            </div>
                            <div class="flex-grow">
                                <h3 class="text-lg font-semibold text-blue-800">${member.name}</h3>
                                <p class="text-gray-600">Total Tabungan: <span class="font-semibold">${formatRupiah(totalTabungan)}</span></p>
                                <p class="text-gray-600">Total Jimpitan: <span class="font-semibold">${formatRupiah(totalJimpitan)}</span></p>
                                ${member.note ? `<div class="mt-2 bg-yellow-50 p-2 rounded-md">
                                    <p class="text-gray-700 text-sm"><i class="fas fa-sticky-note text-yellow-500 mr-1"></i> <span class="italic">${member.note}</span></p>
                                </div>` : ''}
                            </div>
                            <div class="w-full sm:w-48 flex flex-col gap-1">
                                <p class="text-sm font-medium text-gray-700 text-right">Total: ${formatRupiah(totalSaved)}</p>
                            </div>
                        </div>
                    `);

                    $('#membersList').append(memberCard);
                });

                // Update member counter
                const endIndex = Math.min(startIndex + paginationConfig.membersPerPage, filteredMembers.length);
                $('#memberCounter').html(`Menampilkan ${startIndex + 1}-${endIndex} dari ${filteredMembers.length} member`);

                // Render pagination
                renderPagination();
            }

            // Initialize member filters
            setupMemberFilters();
        });
    </script>
</body>

</html>